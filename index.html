<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oil Portrait</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}

body{
  background:#0f0f13;
  overflow:hidden;
  font-family:system-ui,-apple-system,sans-serif;
}

canvas{
  width:100vw;
  height:100vh;
  display:block;
}

/* canvas texture */
body::after{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background:
    repeating-linear-gradient(
      45deg,
      rgba(255,255,255,.03) 0,
      rgba(255,255,255,.03) 1px,
      transparent 2px,
      transparent 4px
    );
  mix-blend-mode:overlay;
}

.final{
  position:absolute;
  bottom:7%;
  width:100%;
  text-align:center;
  color:rgba(255,255,255,.85);
  font-size:1rem;
  letter-spacing:.5px;
  opacity:0;
  transition:opacity 3s ease;
}
.final.show{opacity:1}
</style>
</head>

<body>

<canvas id="c"></canvas>
<div class="final" id="final">Some things are worth creating slowly.</div>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const DPR = devicePixelRatio || 1;

let W,H;
function resize(){
  W = canvas.width = innerWidth * DPR;
  H = canvas.height = innerHeight * DPR;
}
resize();
addEventListener("resize", resize);

const img = new Image();
img.src = "portrait.jpg";

let strokes=[], index=0;

img.onload = () => start();

function start(){
  // ----- STEP 1: CLEAR UNDERPAINTING -----
  const scale = Math.min(W/img.width, H/img.height);
  const iw = img.width * scale;
  const ih = img.height * scale;
  const ix = (W - iw)/2;
  const iy = (H - ih)/2;

  ctx.fillStyle="#0f0f13";
  ctx.fillRect(0,0,W,H);

  ctx.globalAlpha = 0.35;      // IMPORTANT: structure visible
  ctx.drawImage(img, ix, iy, iw, ih);
  ctx.globalAlpha = 1;

  // ----- STEP 2: PREPARE STROKES -----
  const t = document.createElement("canvas");
  const tctx = t.getContext("2d");
  t.width=W; t.height=H;
  tctx.drawImage(img, ix, iy, iw, ih);
  const data = tctx.getImageData(0,0,W,H).data;

  for(let y=0;y<H;y+=6){
    for(let x=0;x<W;x+=6){
      const i=(y*W+x)*4;
      if(data[i+3]<20) continue;

      const r=data[i], g=data[i+1], b=data[i+2];
      const brightness=(r+g+b)/3;

      strokes.push({
        x,y,r,g,b,
        size: brightness<90 ? 7 : brightness<160 ? 5 : 3,
        alpha: brightness<90 ? .25 : .18,
        angle: Math.random()*Math.PI
      });
    }
  }

  strokes.sort(()=>Math.random()-.5);
  requestAnimationFrame(paint);
}

function paint(){
  for(let i=0;i<90;i++){
    const s=strokes[index];
    if(!s) break;

    ctx.strokeStyle=`rgba(${s.r},${s.g},${s.b},${s.alpha})`;
    ctx.lineWidth=s.size;
    ctx.lineCap="round";

    const len=s.size*2.8;

    ctx.beginPath();
    ctx.moveTo(
      s.x + Math.cos(s.angle)*len,
      s.y + Math.sin(s.angle)*len
    );
    ctx.lineTo(
      s.x - Math.cos(s.angle)*len,
      s.y - Math.sin(s.angle)*len
    );
    ctx.stroke();

    index++;
  }

  if(index<strokes.length){
    requestAnimationFrame(paint);
  } else {
    document.getElementById("final").classList.add("show");
  }
}
</script>

</body>
</html>
